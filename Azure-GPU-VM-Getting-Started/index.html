<!DOCTYPE html>
<html>
  <head>
    <title>How to use GPU based Virtual Machines on Azure! – Lernen durch Codierung</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="Microsoft recently (August 4, 2016) announced their Azure N-Series Virtual Machines. I was at the time evaluating options to serve deep learning models on GPUs and decided to give it a try. It was actually pretty straightforward." />
    <meta property="og:description" content="Microsoft recently (August 4, 2016) announced their Azure N-Series Virtual Machines. I was at the time evaluating options to serve deep learning models on GPUs and decided to give it a try. It was actually pretty straightforward." />
    
    <meta name="author" content="kampta" />

    
    <meta property="og:title" content="How to use GPU based Virtual Machines on Azure!" />
    <meta property="twitter:title" content="How to use GPU based Virtual Machines on Azure!" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="kampta - Lernen durch Codierung" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://www.gravatar.com/avatar/a3fe98194076676cf4674a06e63c56ad.jpg" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">kampta</a></h1>
            <p class="site-description">Lernen durch Codierung</p>
          </div>

          <nav>
            <a href="/research">Research</a>
            <a href="/blog">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>How to use GPU based Virtual Machines on Azure!</h1>

  <div class="entry">
    <p>Microsoft recently <a href="https://azure.microsoft.com/en-in/blog/azure-n-series-preview-availability/">announced</a> provision of GPU based Virtual Machines as Azure N-Series. There are two categories:</p>

<ol>
  <li>NC-Series (compute-focused GPUs), powered by Tesla K80 GPUs</li>
  <li>NV-Series (focused on visualization), using Tesla M60 GPUs and NVIDIA GRID for desktop accelerated applications</li>
</ol>

<p>I needed GPU based servers for serving few deep learning models, so NC-Series was the obvious choice.</p>

<h2 id="creating-a-new-vm">Creating a new VM</h2>

<p>I am not big Microsoft buff and don’t use <a href="https://docs.microsoft.com/en-us/rest/api/resources/">ARM</a> for managing Azure resources. I resort to <a href="https://docs.docker.com/machine/"><code class="highlighter-rouge">docker-machine</code></a> to manage all my VMs. It makes getting started/switching over to any cloud server, be it Azure/AWS/DigitalOcean very seemless. If you haven’t already, I’ll recommend <a href="https://docs.docker.com/machine/">installing</a> it right away.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-machine create --driver azure \
	--azure-subscription-id ############################### \
	--azure-location southcentralus \
	--azure-image canonical:UbuntuServer:16.04.0-LTS:latest \
	--azure-size Standard_NC6 \
	--azure-open-port 80 --azure-open-port 8000 --azure-open-port 8888 \
	my-awesome-machine
</code></pre></div></div>

<p>Note that NC-Series is available only in <code class="highlighter-rouge">southcentralus</code> at the time of writing the post.</p>

<p>If you get an error like this</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error creating machine: Error in driver during machine creation: compute.VirtualMachinesClient#CreateOrUpdate: Failure sending request: StatusCode=409 -- Original Error: Long running operation terminated with status 'Failed': Code='OperationNotAllowed' Message='Operation results in exceeding quota limits of Core. Maximum allowed: 0, Current in use: 0, Additional requested: 6.'
</code></pre></div></div>

<p>That might mean, you need to <a href="http://gpu.azure.com">apply here</a> to get approval for N-Series.</p>

<h2 id="install-nvidia-drivers">Install nvidia drivers</h2>

<p>That’s straightforward too</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-machine ssh my-awesome-machine
sudo apt-get purge nvidia-*
sudo add-apt-repository ppa:graphics-drivers/ppa
sudo apt-get update
sudo apt-get install nvidia-370
</code></pre></div></div>

<p>Logout of the machine, restart it and test if the drivers were installed properly</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-machine restart my-awesome-machine
docker-machine ssh my-awesome-machine
nvidia-smi
</code></pre></div></div>

<h2 id="install-docker">Install <code class="highlighter-rouge">docker</code></h2>

<p>Cool, now we just have to install docker on the server. I’ll just write down the instructions from the <a href="https://docs.docker.com/engine/installation/linux/ubuntulinux/">documentation</a>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install linux-image-extra-$(uname -r) linux-image-extra-virtual
sudo apt-get install docker-engine
</code></pre></div></div>

<h2 id="install-nvidia-docker">Install <code class="highlighter-rouge">nvidia-docker</code></h2>

<p>Almost there, copying instructions from nvidia’s github page for sake of completion. More information on <a href="https://github.com/NVIDIA/nvidia-docker/wiki/Why%20NVIDIA%20Docker">why NVIDIA docker</a>, and other details refer <a href="https://github.com/NVIDIA/nvidia-docker">https://github.com/NVIDIA/nvidia-docker</a>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget -P /tmp https://github.com/NVIDIA/nvidia-docker/releases/download/v1.0.0-rc.3/nvidia-docker_1.0.0.rc.3-1_amd64.deb
sudo dpkg -i /tmp/nvidia-docker*.deb &amp;&amp; rm /tmp/nvidia-docker*.deb

# Test nvidia-smi
sudo nvidia-docker run --rm nvidia/cuda nvidia-smi
</code></pre></div></div>

<h2 id="testing-gpu-with-tensorflow">Testing GPU with <code class="highlighter-rouge">tensorflow</code></h2>

<p><code class="highlighter-rouge">tensorflow</code> provides docker images having all dependencies for running tensorflow with CUDA. Run a container in detached mode like this</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nvidia-docker run -itd -p 8888:8888 -e "PASSWORD=password" --name=tf_container gcr.io/tensorflow/tensorflow:latest-gpu
</code></pre></div></div>

<p>In this command, we are</p>

<ul>
  <li>Exposing ports 8888, so that you can browse to <a href="http://IP_OF_MY_AWESOME_MACHINE:8888">http://IP_OF_MY_AWESOME_MACHINE:8888</a> and go to the <code class="highlighter-rouge">jupyter</code> server</li>
  <li>Setting PASSWORD=password, which you will need to enter <code class="highlighter-rouge">jupyter</code> server</li>
  <li>Running in a detached mode, so docker can keep running in the background</li>
</ul>

<p>Finally, login to the container and test it out. You should see some output like this</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Note that we named container as `tf_container` in the last command
sudo docker exec -it tf_container bash

ipython
In [1]: import tensorflow as tf
I tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcublas.so locally
I tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcudnn.so locally
I tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcufft.so locally
I tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcuda.so.1 locally
I tensorflow/stream_executor/dso_loader.cc:128] successfully opened CUDA library libcurand.so locally

In [2]: sess = tf.Session(config=tf.ConfigProto(log_device_placement=True))
I tensorflow/core/common_runtime/gpu/gpu_device.cc:885] Found device 0 with properties:
name: Tesla K80
major: 3 minor: 7 memoryClockRate (GHz) 0.8235
pciBusID 9540:00:00.0
Total memory: 11.17GiB
Free memory: 11.11GiB
I tensorflow/core/common_runtime/gpu/gpu_device.cc:906] DMA: 0
I tensorflow/core/common_runtime/gpu/gpu_device.cc:916] 0:   Y
I tensorflow/core/common_runtime/gpu/gpu_device.cc:975] Creating TensorFlow device (/gpu:0) -&gt; (device: 0, name: Tesla K80, pci bus id: 9540:00:00.0)
Device mapping:
/job:localhost/replica:0/task:0/gpu:0 -&gt; device: 0, name: Tesla K80, pci bus id: 9540:00:00.0
I tensorflow/core/common_runtime/direct_session.cc:255] Device mapping:
/job:localhost/replica:0/task:0/gpu:0 -&gt; device: 0, name: Tesla K80, pci bus id: 9540:00:00.0
</code></pre></div></div>

<p>That’s all for today. Have fun with docker and tensorflow.</p>

  </div>

  <div class="date">
    Written on November 11, 2016
  </div>

  
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'kampta';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:kamalgupta308@gmail.com"><i class="svg-icon email"></i></a>
<a href="https://www.facebook.com/kamalgupta09"><i class="svg-icon facebook"></i></a>
<a href="https://www.flickr.com/kamalgupta09"><i class="svg-icon flickr"></i></a>
<a href="https://github.com/kampta"><i class="svg-icon github"></i></a>
<a href="https://instagram.com/kampta"><i class="svg-icon instagram"></i></a>
<a href="https://www.linkedin.com/in/kamalgupta09"><i class="svg-icon linkedin"></i></a>


<a href="https://www.twitter.com/kamalgupta09"><i class="svg-icon twitter"></i></a>
<a href="http://stackoverflow.com/users/2353472/kampta"><i class="svg-icon stackoverflow"></i></a>


        </footer>
      </div>
    </div>

    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-38633444-2', 'auto');
		ga('send', 'pageview', {
		  'page': '/Azure-GPU-VM-Getting-Started/',
		  'title': 'How to use GPU based Virtual Machines on Azure!'
		});
	</script>
	<!-- End Google Analytics -->


  </body>
</html>
